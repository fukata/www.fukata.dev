I"<h1 id="digital-oceanからfirebaseに乗り換え">Digital OceanからFirebaseに乗り換え</h1>

<p>自分で運用しているとあるサービスをDigital OceanからFirebaseに乗り換えしました。</p>

<p>理由は特に重要でもないサービスに毎月数十ドルかかっているのが嫌だったからです。結局このサービスも2年近くダラダラと動いており数十ドル×24ヶ月以上と考えると非常に損した気持ちになります。</p>

<p>本日、11月02日が仕事が休みだったこともあり以前からちまちま進めていたリプレイスを一気に進めることにしました。</p>

<h1 id="乗り換え先としてfirebaseを選択">乗り換え先としてFirebaseを選択</h1>

<p>元々、Rails + Sidekiq + Capybara + MySQLという構成でしたが、当面必要な機能はFunctionsで十分そうだったのでFunctions + Firestoreにして、言語もTypeScript + Puppeteerにしました。</p>

<p>以前は管理用のUIもありましたが特に重要ではなかったので削除しました。</p>

<h1 id="typescriptを選んだ理由">TypeScriptを選んだ理由</h1>

<p>最近、仕事や趣味でRubyを使うことが多く、TypeScriptを多く触る機会が欲しかったというのが一番の理由です。</p>

<h1 id="functions">Functions</h1>

<p>APIはもちろん、定期実行も簡単に実装できるのは嬉しい。</p>

<p>さらにFirestoreへのアクセスも簡単なのでさくっとAPI生やしたり定期実行を行ってデータを永続化するのが非常に楽です。</p>

<h1 id="firestore">Firestore</h1>

<p>特に深く考えずに実装すると read/write が多くなってしまい無料枠をあっさり超えそうだったので無駄な read/write が発生しないようにチューニングしました。</p>

<h2 id="readがやたらと多い">readがやたらと多い</h2>

<p>read/writeを改善したと思って定期的に確認していたら以前より悪化していることが分かりました。</p>

<p>ただ、コードをいくら見てもreadが増える原因となるような箇所が見つからなかったのでもしかしたらと思って探してみるとどうやらfirebaseコンソール上でfirestoreのデータを閲覧した時もreadが増えるらしいです。</p>

<p><a href="https://stackoverflow.com/questions/54729505/google-cloud-firestore-console-reading-of-all-documents-and-charges">Google Cloud Firestore console reading of all documents and charges - Stack Overflow</a></p>

<h1 id="puppeteer">Puppeteer</h1>

<p>capybaraから移ったということもありAPIの違いなどは最初は違和感がありましたが慣れれば特に不自由なことは今のところありません。</p>

<p>ただ、Functions上で動かしているからなのかタイムアウトが発生することがあったりmemory limitが発生してしまうことがあるのでこの辺は要調整です。</p>
:ET